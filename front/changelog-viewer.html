<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="styles/style.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
        <script src="Stuk-jszip-3109282/dist/jszip.js"></script>
    </head>
    <body>
    <nav class="navbar navbar-light bg-white">
        <a class="navbar-brand" href="#">
            <img src="images/git_logo.png" width="30" height="30" class="d-inline-block align-top" alt="">
            <strong>GIT - Log Viewer</strong>
        </a>
        
        <div class="text-right"><a href="https://github.com"><img src="images/github.jpg" width=200px/></a><a href="https://gitlab.com"><img src="images/gitlab.png" width=125px/></a></div>
        
    </nav>
    <div class="container login-container">
        <div class="row">
            <div class="col-md-6 login-form-1">
                <h3><span>&#x26B2; </span>Directory<span> &#x26B2;</span></h3><br>
                <div class="custom-file">
                    <input id="directory" class="custom-file-input" type="file" webkitdirectory mozdirectory />
                    <p><label class="custom-file-label" for="customFile" id="label">Choose file</label></p>
                </div>
                <div class="form-group mt-3">
                    <button onclick="directory()" class="btnSubmit">Submit</button>
                </div>
            </div>
            <div class="col-md-6 login-form-2">
                <h3><span>&#x26B2; </span>Url<span> &#x26B2;</span></h3><br>
                <input type="text" id="url" class="form-control" placeholder="Your URL" value="" />
                <div class="form-group mt-3">
                    <button onclick="fromUrl()" class="btnSubmit">Submit</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-md-6" id="log">
            </div>
            <div class="col-md-6" id="precision"></div>
        </div>
    </div>
    <script>

    $( "#directory" ).change(function() {
        $("#label").text("Selected files");
    });
    
    //Create random Int
    function getRandomInt(max) 
    {
        return Math.floor(Math.random() * Math.floor(max));
    }

    //Create log viewer from an URL. Use an API
    function fromUrl ()
    {
        initialize();
        //Create request
        var requete = $("#url").val();
        var url = "http://localhost:8081/fromUrl?url="+requete;
        //Table wich contains color. It's used to random color
        var color = ["#f04f32", "#88b950", "#1fb3b2"];
        str="";
        //GET request
        $.get(url, function(data, status){
            //Unique values
            var tabAuthor = new Set();
            for (elt in data)
            {
                //Memorize values
                var author = data[elt]["author"];
                var date = data[elt]["date"];
                var message = data[elt]["message"];
                //Adding in str
                str += log_viewer (color[getRandomInt(3)], message, author, new Date(date))
                //Adding in table
                tabAuthor.add(author);
            }
            //Displaying
            display_viewer(str);
            //Author's list
            for (elt of tabAuthor)
            {
                str = "&#8627; "+elt+"<br>";
            }
            //Displaying informations
            display_informations(str, data);
        }) 
    }

    //Display log viewer
    function display_viewer (str)
    {
        jQuery($("#log")).append("<div class='jumbotron'><h2>Log viewer<h2><hr>\
            <div class='row'><div class='col-md-1 line' ></div>\
            <div class='col-md-11'>"+str+"</div></div></div>");
    }

    //Display one commit
    function log_viewer (color, message, author, date)
    {
        return '\
        <div class="card text-white mb-3" style="max-width: auto; background-color : '+color+' !important">\
            <div class="card-header"><small>'+message+'</small></div>\
                <div class="card-body"><h5 class="card-title">By '+author+'</h5>\
                <p class="card-text"><small>On '+date+'</small></p>\
            </div>\
        </div>';
    }

    //Display infirmations
    function display_informations (str, data)
    {
        str = '<div class="card text-white mb-3" style="max-width: auto; background-color : #1fb3b2 !important">\
                <div class="card-header"><small>Contributors</small></div>\
                    <div class="card-body"><h5 class="card-title">'+str+'</h5>\
                </div></div>\
                <div class="card text-white mb-3" style="max-width: auto; background-color : #88b950 !important">\
                <div class="card-header"><small>Commits</small></div>\
                    <div class="card-body"><h5 class="card-title">'+data.length+'</h5>\
                </div>';

        jQuery($("#precision")).append("<div class='jumbotron'><h2>Informations<h2><hr>\
        <div class='col-md-11'>"+str+"</div></div>");
    }

    //Create a zip from an existing folder
    function getZip ()
    {
        var zip = new JSZip();
        var iptEls = document.querySelectorAll('#directory');
        [].forEach.call(iptEls, function(iptEl) {
            console.log(iptEl.files);
            $.each(iptEl.files,function(i,file){
                zip.file(file.webkitRelativePath, file, {
                    createFolders: true // default value
                });
            })
            zip.folder(".git");
        })
        return zip;
    }

    //Initialize displaying
    function initialize ()
    {
        $("#log").html("");
        $("#precision").html("");
    }
 
    //Create log viewer from a directory
    function directory ()
    {
        initialize();
        zip = getZip();
        zip.generateAsync({type:"blob"})
        .then(function(content) {
            //Create new File
            var fileObj = new File([content], ".zip");
            //Initialize a form data
            var fd = new FormData();
            fd.append('file', fileObj);
            //POST request
            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: 'http://localhost:8081/upload',
                data: fd,
                processData: false, //prevent jQuery from automatically transforming the data into a query string
                contentType: false,
                cache: false,
                timeout: 600000,
                success: function (data) {
                    $("#btnSubmit").prop("disabled", false);
                    var str = "";
                    //Table wich contains color. It's used to random color
                    var color = ["#f04f32", "#88b950", "#1fb3b2"];
                    //Unique value
                    var tabAuthor = new Set();
                    for (elt in data)
                    {
                        //Memorize values
                        var id = data[elt]["id"];
                        var author = data[elt]["author"]["name"];
                        var date = data[elt]["author"]["when"];
                        var message = data[elt]["message"];
                        //Adding in str
                        str += log_viewer (color[getRandomInt(3)], message, author, new Date(date))
                        //Adding in table
                        tabAuthor.add(author);
                    }
                    //Displaying
                    display_viewer(str);
                    //Author's list
                    for (elt of tabAuthor)
                    {
                        str = "&#8627; "+elt+"<br>";
                    }
                    //Display informations
                    display_informations(str, data);

                },
                error: function (e) {
                    //Display error
                    console.log("ERROR : ", e);
                    $("#btnSubmit").prop("disabled", false);
                }
            });
            
        });
    }    
    </script>
    </body>
</html>