<!DOCTYPE html>
<html>
        <head>
            <link rel="stylesheet" href="style.css">
            <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
            <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
            <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
            <script src="Stuk-jszip-3109282/dist/jszip.js"></script>
            <!------ Include the above in your HEAD tag ---------->
        </head>
        <body>
            <style>
                .icon {
                    font-size: 75px;
                }
            </style>
            <!-- As a heading -->
        <nav class="navbar navbar-light bg-light">
            <span class="navbar-brand mb-0 h1">GIT - Log Viewer</span>
        </nav>
        <div class="container login-container">
            <div class="row">
                <div class="col-md-6 login-form-1">
                    <h3><span>&#x26B2; </span>Directory<span> &#x26B2;</span></h3>
                    <p>Directory: <input id="directory" type="file" webkitdirectory mozdirectory /></p>
                    <div class="form-group">
                        <button onclick="valider()" class="btnSubmit">Valider</button>
                    </div>
                </div>
                <div class="col-md-6 login-form-2">
                    <h3><span>&#x26B2; </span>Url<span> &#x26B2;</span></h3>
                    <p><input type="text" class="form-control" placeholder="Your URL" value="" /></p>
                </div>
            </div>
        </div>
        <div class="container" id="log">

        </div>
<script>

    function getRandomInt(max) {
        return Math.floor(Math.random() * Math.floor(max));
    }
 
    function valider ()
    {
        console.log("Starting.....");
        var zip = new JSZip();

        var iptEls = document.querySelectorAll('#directory');
        [].forEach.call(iptEls, function(iptEl) {
            console.log(iptEl.files);
            $.each(iptEl.files,function(i,file){
                zip.file(file.webkitRelativePath, file, {
                    createFolders: true // default value
                });
            })
            zip.folder(".git");
        })

        zip.generateAsync({type:"blob"})
        .then(function(content) {
            // see FileSaver.js
            console.log('Compression complete!');
            // Create file object to upload
            var fileObj = new File([content], ".zip");
            console.log('File object created:', fileObj);
            var fd = new FormData();
            fd.append('file', fileObj);

            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: 'http://localhost:8081/upload',
                data: fd,
                //http://api.jquery.com/jQuery.ajax/
                //https://developer.mozilla.org/en-US/docs/Web/API/FormData/Using_FormData_Objects
                processData: false, //prevent jQuery from automatically transforming the data into a query string
                contentType: false,
                cache: false,
                timeout: 600000,
                success: function (data) {

                    console.log("SUCCESS : ", data);
                    $("#btnSubmit").prop("disabled", false);
                    var str = "";
                    var color = ["red", "green", "blue"];
                    for (elt in data)
                    {
                        console.log(data[elt]);
                        str = "<br><span class='icon' style='color:"+color[getRandomInt(3)]+"''>&#x21e9;</span><h3>"+data[elt]+"</h3><br><div></div>"+str
                    }

                    jQuery($("#log")).append("<div class='jumbotron login-container text-center'><h2>Log viewer<h2><hr>"+str+"</div>");

                },
                error: function (e) {

                    console.log("ERROR : ", e);
                    $("#btnSubmit").prop("disabled", false);

                }
            });
            
        });

        /*var iptEls = document.querySelectorAll('#directory');
        [].forEach.call(iptEls, function(iptEl) {
                console.log(iptEl.files);
                console.log("Searching...");
                var data = new FormData();
                jQuery.each(jQuery('input')[0].files, function(i, file) {
                    data.append('file-'+i, file);
                });

                var data = new FormData();

                $.each(iptEl.files,function(i,file){
                    data.append('file', file);
                })

                $.ajax({
                    type: "POST",
                    enctype: 'multipart/form-data',
                    url: 'http://localhost:8081/upload',
                    data: data,
                    //http://api.jquery.com/jQuery.ajax/
                    //https://developer.mozilla.org/en-US/docs/Web/API/FormData/Using_FormData_Objects
                    processData: false, //prevent jQuery from automatically transforming the data into a query string
                    contentType: false,
                    cache: false,
                    timeout: 600000,
                    success: function (data) {

                        $("#result").text(data);
                        console.log("SUCCESS : ", data);
                        $("#btnSubmit").prop("disabled", false);

                    },
                    error: function (e) {

                        $("#result").text(e.responseText);
                        console.log("ERROR : ", e);
                        $("#btnSubmit").prop("disabled", false);

                    }
                });

                

        });*/
    }    
</script>
    </body>
</html>